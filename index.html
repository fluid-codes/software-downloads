<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ANSYS Software Downloads</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 2rem; }
    h1 { color: #004080; }
    .banner { background: #ffeeba; border: 1px solid #f0ad4e; padding: 10px; margin-bottom: 15px; font-weight: bold; white-space: pre-line; }
    select, input[type="text"] { padding: 6px; margin-right: 10px; }
    .toggle-button { display: inline-block; margin-top: 10px; }
    .category { margin-top: 1.5rem; background: #fff; border: 1px solid #ccc; border-radius: 8px; }
    .category h2 { margin: 0; padding: 0.75rem; background-color: #004080; color: white; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .category-content { display: none; padding: 1rem; }
    .category-content ul { list-style: none; padding-left: 0; }
    .category-content li { margin-bottom: 0.5rem; }
    .download-link { color: #0066cc; text-decoration: none; }
    .download-link:hover { text-decoration: underline; }
    .download-header::before { content: "\1F4E5 "; }
    #logBox { background: #eef; border: 1px solid #88c; padding: 1rem; margin-top: 2rem; white-space: pre-wrap; max-height: 300px; overflow-y: scroll; display: none; }
  </style>
</head>
<body>
  <h1><span class="download-header"></span>ANSYS Software Downloads</h1>

  <div class="banner">
    üìå Please select Version and OS to view categorized downloads
    üîç Use search to filter within selection ‚Äî or switch to global search mode
  </div>

  <div>
    <label for="versionFilter">Version:</label>
    <select id="versionFilter">
      <option value="">-- Select Version --</option>
    </select>

    <label for="osFilter">OS:</label>
    <select id="osFilter">
      <option value="">-- Select OS --</option>
    </select>

    <label for="searchInput">Search:</label>
    <input type="text" id="searchInput" placeholder="Search by file name" />

    <div class="toggle-button">
      Search Mode: 
      <button onclick="setSearchMode('filtered')" id="btnFiltered">[Filtered ‚úÖ]</button>
      <button onclick="setSearchMode('global')" id="btnGlobal">[Global ‚ùå]</button>
      
    </div>
  </div>

  <div id="fileContainer"></div>

  <script>
    const JSON_URL = "https://script.google.com/macros/s/AKfycbylJt3kbvwBBf5cgILgEftSq3ohUPMD-GzEnvjqzxD3ganeTev1TtNQW9nELHrBQrMS/exec";
    let fileData = [];
    let searchMode = 'filtered';

    const simpleCategories = [
      ["Electronics", ["motorcad", "siwave", "electronic"]],
      ["Fluids", ["fluid", "fluent", "cfx"]],
      ["Structures", ["structure"]],
      ["Fluids and Structures", []],
      ["Materials", ["granta", "material"]],
      ["Forming", ["forming"]],
      ["Acoustics", ["sound", "sas", "asdr"]],
      ["Optical", ["speos", "opticstudio", "zemax"]],
      ["Discovery", ["discovery"]],
      ["PrepPost", ["preppost"]],
      ["Photonics", ["lumerical", "photonics"]]
    ];

            function categorize(file) {
      const name = file.name.toLowerCase();
      const hasFluid = name.includes("fluid") || name.includes("fluent") || name.includes("cfx");
      const hasStructure = name.includes("structure");

      if (hasFluid && hasStructure) {
        
        return "Fluids and Structures";
      }

      for (const [category, keywords] of simpleCategories) {
        if (category === "Fluids and Structures") continue;
        if (keywords.some(k => name.includes(k))) {
          
          return category;
        }
      }

      
      return "Other Tools";
    }

    async function loadJSON() {
      try {
        const res = await fetch(JSON_URL);
        fileData = await res.json();
        populateFilters();
        
        // Final preselection at the very end
        const versionFilter = document.getElementById("versionFilter");
        const osFilter = document.getElementById("osFilter");

        const validVersions = Array.from(versionFilter.options).map(o => o.value).filter(v => v);
        const validOS = Array.from(osFilter.options).map(o => o.value).filter(v => v);

        if (validVersions.length) versionFilter.value = validVersions[0];
        if (validOS.length) osFilter.value = validOS[0];

        renderCategories();
    
      } catch (err) {
        console.error("Failed to load JSON:", err);
        alert("Failed to load data.");
      }
    }

    function populateFilters() {
      const versionRegex = /^20\d{2}\sR\d$/;
      const versionSet = new Set();

      fileData.forEach(file => {
        if (versionRegex.test(file.version)) versionSet.add(file.version);
      });

      const sortedVersions = [...versionSet].sort((a, b) => b.localeCompare(a));
      const versionFilter = document.getElementById("versionFilter");

      sortedVersions.forEach(version => {
        const opt = document.createElement("option");
        opt.value = version;
        opt.textContent = version;
        versionFilter.appendChild(opt);
      });

      ["Windows", "Linux"].forEach(os => {
        const opt = document.createElement("option");
        opt.value = os;
        opt.textContent = os;
        document.getElementById("osFilter").appendChild(opt);
      });

      document.getElementById("versionFilter").addEventListener("change", renderCategories);
      document.getElementById("osFilter").addEventListener("change", renderCategories);
      document.getElementById("searchInput").addEventListener("input", renderCategories);
    }

    function setSearchMode(mode) {
      searchMode = mode;
      document.getElementById("btnFiltered").textContent = `[Filtered ${mode === 'filtered' ? '‚úÖ' : '‚ùå'}]`;
      document.getElementById("btnGlobal").textContent = `[Global ${mode === 'global' ? '‚úÖ' : '‚ùå'}]`;
      
        // Final preselection at the very end
        const versionFilter = document.getElementById("versionFilter");
        const osFilter = document.getElementById("osFilter");

        const validVersions = Array.from(versionFilter.options).map(o => o.value).filter(v => v);
        const validOS = Array.from(osFilter.options).map(o => o.value).filter(v => v);

        if (validVersions.length) versionFilter.value = validVersions[0];
        if (validOS.length) osFilter.value = validOS[0];

        renderCategories();
    
    }

    function renderCategories() {
      const version = document.getElementById("versionFilter").value;
      const os = document.getElementById("osFilter").value;
      const search = document.getElementById("searchInput").value.toLowerCase();
      const container = document.getElementById("fileContainer");
      container.innerHTML = "";

      const grouped = {};
      simpleCategories.forEach(([cat]) => grouped[cat] = []);
      grouped["Fluids and Structures"] = [];
      grouped["Other Tools"] = [];

      let results = fileData;

      if (searchMode === 'filtered') {
        if (!version || !os) return;
        results = results.filter(f => f.version === version && f.os === os);
      }

      if (search) {
        results = results.filter(f => f.name.toLowerCase().includes(search));
      }

      results.sort((a, b) => a.name.localeCompare(b.name));
      results.forEach(file => {
        const cat = categorize(file);
        grouped[cat].push(file);
      });

      const categoryOrder = [...simpleCategories.map(([c]) => c), "Fluids and Structures", "Other Tools"];

      categoryOrder.forEach(cat => {
        const section = document.createElement("div");
        section.className = "category";

        const header = document.createElement("h2");
        const icon = document.createElement("span");
        icon.textContent = "‚ûï";
        header.innerHTML = `<span>${cat}</span>`;
        header.appendChild(icon);

        const content = document.createElement("div");
        content.className = "category-content";
        const list = document.createElement("ul");

        grouped[cat].forEach(file => {
          const li = document.createElement("li");
          li.innerHTML = `<a href="${file.url}" target="_blank" class="download-link">‚¨áÔ∏è ${file.name}</a>`;
          list.appendChild(li);
        });

        content.style.display = "none";
        content.appendChild(list);
        header.onclick = () => {
          const isVisible = content.style.display === "block";
          content.style.display = isVisible ? "none" : "block";
          icon.textContent = isVisible ? "‚ûï" : "‚ûñ";
        };

        section.appendChild(header);
        section.appendChild(content);
        container.appendChild(section);
      });
    }

    loadJSON();
  </script>
</body>
</html>
